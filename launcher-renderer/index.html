<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./App/Resources/icon.png">
    <title>StepLauncher</title>
    
    <!-- PRELOAD CRÍTICO -->
    <link rel="preload" href="./Css/global.css" as="style">
    <link rel="preload" href="./Css/launcher.css" as="style">
    <link rel="preload" href="./Css/Layouts/Settings.css" as="style">
    <link rel="modulepreload" href="../launcher-dist/Renderer/Global/Global.js">
    <link rel="modulepreload" href="../launcher-dist/Renderer/Main/Launcher.js">
    
    <!-- ESTILOS -->
    <link rel="stylesheet" href="./Css/global.css">
    <link rel="stylesheet" href="./Css/launcher.css">
    <link rel="stylesheet" href="./Css/Layouts/Settings.css">
</head>
<body class="BodyApp-Root">
    <header class="TitleBar">
        <div class="T-Title">
            <img src="./App/Resources/icon.png" alt="StepLauncher" decoding="async" loading="lazy">
            <p data-lang="Launcher.Title"></p>
        </div>
        <div class="T-Buttons">
            <button onclick="window.ElectronAPI.controlWindow('minimize')" aria-label="Minimizar">
                <img src="./Static/Svg/minus.svg" alt="" decoding="async" loading="lazy">
            </button>
            <button onclick="window.ElectronAPI.controlWindow('maximize')" aria-label="Maximizar">
                <img src="./Static/Svg/square.svg" alt="" decoding="async" loading="lazy">
            </button>
            <button onclick="window.ElectronAPI.controlWindow('close')" aria-label="Cerrar">
                <img src="./Static/Svg/close.svg" alt="" decoding="async" loading="lazy">
            </button>
        </div>
    </header>

    <div class="App-LoaderScreen-UI App-LoadScreen">
        <div class="App-LoaderScreen-Top Close">
            <img src="./App/Resources/icon.png" class="App-LoaderScreen-Logo" alt="Loading" decoding="async" loading="lazy">
        </div>
        <div class="App-LoaderScreen-Bottom Close">
            <p class="App-LoaderScreen-Text" data-lang="ScreenLoader.Inicialization"></p>
        </div>
    </div>

    <main class="App-Root-Main">
        <aside class="App-Sidebar" id="Sidebar">
            <nav class="Items-Container-Sidebar">
                <div class="Sidebar-Item" id="ExpandSidebar">
                    <img src="./Static/Svg/layout-sidebar-left-expand.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.ExpandSidebar" id="TextExpand"></label>
                </div>
                <div class="Sidebar-Item" data-openPanel="Settings">
                    <img src="./Static/Svg/settings.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.Config"></label>
                </div>
                <div class="Sidebar-Item" data-openPanel="Instancies">
                    <img src="./Static/Svg/instancie.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.Instancies"></label>
                </div>
                <div class="Sidebar-Item" data-openPanel="Download">
                    <img src="./Static/Svg/download.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.DownloadMC"></label>
                </div>
                <div class="Sidebar-Item" data-openPanel="Play">
                    <img src="./Static/Svg/play.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.Play"></label>
                </div>
            </nav>
            
            <nav class="Items-Container-Sidebar-BT">
                <div class="Sidebar-Item BellNotification" id="NotificationSection">
                    <img src="./Static/Svg/bell.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.Bell"></label>
                </div>
                <div class="Sidebar-Item" id="ScreenshotsSection">
                    <img src="./Static/Svg/cards.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.Screenshots"></label>
                </div>
                <div class="Sidebar-Item" id="NewsMinecraft">
                    <img src="./Static/Svg/News.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.News"></label>
                </div>
                <div class="Sidebar-Item" id="TerminalBackend">
                    <img src="./Static/Svg/Terminal.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.Console"></label>
                </div>
                <div class="Sidebar-Item" onclick="window.ElectronAPI.openExternal('https://discord.gg/37dYy9apwE')">
                    <img src="./Static/Svg/discord.svg" alt="" decoding="async" loading="lazy">
                    <label data-lang="Sidebar.Discord"></label>
                </div>
            </nav>
        </aside>
        <div class="App-Content">
            <div class="Content" id="Content">
                <section tabindex="-1">
                    <iframe src="./HTML/news.html" loading="lazy" class="NewsIframe" id="IframeNews" title="Minecraft News"></iframe>
                </section>
                <section>
                    <div class="Console" role="log" aria-live="polite"></div>
                </section>
            </div>
        </div>

        <div class="App-Panels-Container-HMTL HTMLLoader-Panel-Unvisible" id="HTMLContainerPanels"></div>
    </main>
    <audio id="Audio-Global" preload="auto"></audio>
    <script type="module" src="../launcher-dist/Renderer/Global/Global.js"></script>
    <script type="module" src="../launcher-dist/Renderer/Main/Launcher.js"></script>
    <script type="module">
        const CONFIG = {
            LOG_LIMIT: 50,
            LOG_UPDATE_INTERVAL: 5000,
            SCROLL_DEBOUNCE: 80,
            TRANSITION_TIMEOUT: 360,
            LABEL_READY_DELAY: 40
        };

        const DOM = {
            content: document.getElementById("Content"),
            consoleDiv: document.querySelector(".Console"),
            expandBtn: document.getElementById("ExpandSidebar"),
            appContent: document.querySelector('.App-Content'),
            textBtn: document.getElementById('TextExpand'),
            sidebar: document.getElementById('Sidebar'),
            newsBtn: document.getElementById("NewsMinecraft"),
            terminalBtn: document.getElementById("TerminalBackend")
        };

        const sections = [...DOM.content.querySelectorAll("section")];
        let currentIndex = 0;
        let scrollTimeout = null;

        const Navigation = {
            getCurrentIndex() {
                const viewportWidth = DOM.content.clientWidth || 1;
                return Math.max(0, Math.min(sections.length - 1, 
                    Math.round(DOM.content.scrollLeft / viewportWidth)));
            },

            scrollTo(index, behavior = "smooth") {
                currentIndex = index;
                DOM.content.scrollTo({ 
                    left: index * DOM.content.clientWidth, 
                    behavior 
                });
            }
        };

        const Sidebar = {
            toggle() {
                const currentSection = Navigation.getCurrentIndex();
                const expanded = DOM.sidebar.classList.toggle('Expand');
                DOM.appContent.classList.toggle('ExpandSidebar');
                
                const langKey = expanded ? "Sidebar.ContractSidebar" : "Sidebar.ExpandSidebar";
                DOM.textBtn.textContent = window.LangAPI?.getText(langKey) || "";
                DOM.sidebar.classList.remove('Labels-Ready');

                this.handleTransition(currentSection);
            },

            handleTransition(currentSection) {
                const onEnd = (ev) => {
                    if (['width', 'padding-top', 'padding'].includes(ev.propertyName)) {
                        this.cleanup(onEnd, currentSection);
                    }
                };

                DOM.sidebar.addEventListener('transitionend', onEnd);
                DOM.appContent.addEventListener('transitionend', onEnd);

                setTimeout(() => this.cleanup(onEnd, currentSection), CONFIG.TRANSITION_TIMEOUT);
            },

            cleanup(handler, section) {
                DOM.sidebar.removeEventListener('transitionend', handler);
                DOM.appContent.removeEventListener('transitionend', handler);
                Navigation.scrollTo(section, 'auto');
                setTimeout(() => DOM.sidebar.classList.add('Labels-Ready'), CONFIG.LABEL_READY_DELAY);
            }
        };

        const Console = {
            safeParse(json) {
                try { 
                    return JSON.parse(json); 
                } catch { 
                    return { 
                        time: new Date().toISOString(),
                        level: "ERROR", 
                        msg: window.LangAPI?.getText("Console.InvalidJSON") || "(JSON inválido)"
                    }; 
                }
            },

            formatTime(isoString) {
                try {
                    return new Date(isoString).toLocaleTimeString();
                } catch {
                    return "??:??:??";
                }
            },

            renderTree(obj, indent = 0) {
                if (!obj || typeof obj !== "object") return "";
                
                const pad = " ".repeat(indent);
                let out = "";

                for (const [key, value] of Object.entries(obj)) {
                    if (value && typeof value === "object" && !Array.isArray(value)) {
                        out += `${pad}${key}:\n${this.renderTree(value, indent + 4)}`;
                    } else {
                        out += `${pad}${key}: ${JSON.stringify(value)}\n`;
                    }
                }
                return out;
            },

            normalizeLog(log) {
                const baseKeys = ['time', 'level', 'msg', 'pid', 'hostname'];
                const details = {};
                let hasDetails = false;

                for (const [key, value] of Object.entries(log)) {
                    if (!baseKeys.includes(key)) {
                        details[key] = value;
                        hasDetails = true;
                    }
                }

                return {
                    timestamp: log.time,
                    level: log.level,
                    message: log.msg,
                    details: hasDetails ? details : null
                };
            },

            renderEntry(rawLog) {
                const log = this.normalizeLog(rawLog);
                const wrap = document.createElement("div");
                wrap.className = `console-entry level-${log.level?.toLowerCase() || "info"}`;

                const noMsg = window.LangAPI?.getText("Console.NoMessage") || "(sin mensaje)";
                wrap.innerHTML = `
                    <div class="entry-header">
                        <span class="time">[${this.formatTime(log.timestamp)}]</span>
                        <span class="level">${log.level}</span>
                        <span class="msg">${log.message || noMsg}</span>
                    </div>
                `;

                if (log.details && Object.keys(log.details).length > 0) {
                    const detailsText = window.LangAPI?.getText("Console.Details") || "Details";
                    const block = document.createElement("div");
                    block.className = "details-block";
                    block.innerHTML = `
                        <div class="tree-head">└── ${detailsText}:</div>
                        <pre class="tree-body">${this.renderTree(log.details, 8)}</pre>
                    `;
                    wrap.appendChild(block);
                }

                return wrap;
            },

            async load() {
                if (!DOM.consoleDiv) return;

                const stickDown = DOM.consoleDiv.scrollTop + DOM.consoleDiv.clientHeight >= 
                                 DOM.consoleDiv.scrollHeight - 5;

                let raw = await window.StepLauncherLogger?.getMemoryHistory() || [];
                if (raw.length > CONFIG.LOG_LIMIT) {
                    raw = raw.slice(-CONFIG.LOG_LIMIT);
                }

                const logs = raw.map(this.safeParse.bind(this));
                const frag = document.createDocumentFragment();
                
                logs.forEach(log => frag.appendChild(this.renderEntry(log)));
                
                DOM.consoleDiv.innerHTML = "";
                DOM.consoleDiv.appendChild(frag);

                if (stickDown) {
                    DOM.consoleDiv.scrollTop = DOM.consoleDiv.scrollHeight;
                }
            }
        };

        DOM.content.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                currentIndex = Navigation.getCurrentIndex();
            }, CONFIG.SCROLL_DEBOUNCE);
        });

        DOM.expandBtn?.addEventListener('click', () => Sidebar.toggle());
        DOM.newsBtn?.addEventListener("click", () => Navigation.scrollTo(0));
        DOM.terminalBtn?.addEventListener("click", () => Navigation.scrollTo(1));
        window.addEventListener("resize", () => Navigation.scrollTo(currentIndex));

        Console.load();
        setInterval(() => Console.load(), CONFIG.LOG_UPDATE_INTERVAL);
    </script>
</body>
</html>